<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome拡張機能デバッグ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .log-output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .instruction {
            background: #e7f3ff;
            padding: 10px;
            border-left: 4px solid #2196F3;
            margin: 10px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .folder-structure {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Chrome拡張機能デバッグツール</h1>
    
    <div class="instruction">
        <h3>📋 デバッグ手順</h3>
        <ol>
            <li>Chrome拡張機能のページを開く</li>
            <li>開発者ツール (F12) を開く</li>
            <li>Consoleタブを選択</li>
            <li>フォルダをクリックしてログを確認</li>
            <li>下記のボタンでログをクリアできます</li>
        </ol>
    </div>

    <div class="debug-section">
        <h3>🔍 デバッグコマンド</h3>
        <button onclick="clearConsole()">コンソールクリア</button>
        <button onclick="analyzeStructure()">HTML構造解析</button>
        <button onclick="listEventListeners()">イベントリスナー確認</button>
        <button onclick="testFolderClicks()">フォルダクリックテスト</button>
    </div>

    <div class="debug-section">
        <h3>📊 期待されるログパターン</h3>
        <div class="log-output">
DEBUG: setupFolderClickHandler called {
  containerId: "bookmarkContainer",
  containerClassName: "",
  allBookmarksCount: X,
  folderHeaderCount: X
}

// フォルダクリック時:
DEBUG: Click event detected: {
  targetTag: "H2" または "SPAN",
  targetClass: "folder-title" または "expand-icon",
  folderHeader: "found",
  hasSubfolders: true
}

DEBUG: Folder header clicked

DEBUG: Found folder: {
  title: "フォルダ名",
  id: "XXX",
  subfolderCount: X,
  hasSubfolders: true,
  currentExpanded: false/true
}

DEBUG: Toggling folder state: {
  before: false,
  after: true,
  hasSubfolders: true
}

DEBUG: UI update completed for folder: "フォルダ名"
        </div>
    </div>

    <div class="debug-section">
        <h3>⚠️ 問題診断チェックリスト</h3>
        <div id="diagnostics">
            <div class="instruction">
                <h4>チェック項目:</h4>
                <ul>
                    <li>✅ `setupFolderClickHandler called` ログが表示される</li>
                    <li>✅ フォルダクリック時に `Click event detected` が表示される</li>
                    <li>✅ `folderHeader: "found"` が表示される</li>
                    <li>✅ `hasSubfolders: true` が表示される（サブフォルダありの場合）</li>
                    <li>✅ `Found folder` で正しいフォルダ情報が表示される</li>
                    <li>✅ `Toggling folder state` でstateの変更が表示される</li>
                    <li>✅ `UI update completed` が表示される</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h3>🛠️ HTML構造分析結果</h3>
        <div id="structure-analysis" class="folder-structure">
            ここに構造解析の結果が表示されます
        </div>
    </div>

    <script>
        function clearConsole() {
            console.clear();
            console.log('🧹 コンソールをクリアしました');
        }

        function analyzeStructure() {
            console.log('🔍 HTML構造を解析中...');
            
            // ブックマークコンテナを取得
            const container = document.getElementById('bookmarkContainer');
            if (!container) {
                console.error('❌ bookmarkContainer が見つかりません');
                return;
            }

            // フォルダヘッダーの数
            const folderHeaders = container.querySelectorAll('.folder-header');
            console.log(`📁 フォルダヘッダー数: ${folderHeaders.length}`);

            // サブフォルダがあるフォルダの数
            const hasSubfolders = container.querySelectorAll('.folder-header.has-subfolders');
            console.log(`📂 サブフォルダありフォルダ数: ${hasSubfolders.length}`);

            // サブフォルダコンテナの数
            const subfolderContainers = container.querySelectorAll('.subfolders-container');
            console.log(`📦 サブフォルダコンテナ数: ${subfolderContainers.length}`);

            // 各フォルダの詳細情報
            folderHeaders.forEach((header, index) => {
                const folder = header.closest('.bookmark-folder');
                const folderId = folder?.getAttribute('data-folder-id');
                const title = header.querySelector('.folder-title')?.textContent;
                const hasSubfoldersClass = header.classList.contains('has-subfolders');
                const expandIcon = header.querySelector('.expand-icon');
                
                console.log(`フォルダ ${index + 1}:`, {
                    title,
                    folderId,
                    hasSubfolders: hasSubfoldersClass,
                    hasExpandIcon: !!expandIcon,
                    expandIconText: expandIcon?.textContent
                });
            });

            // 結果をHTMLにも表示
            const analysisDiv = document.getElementById('structure-analysis');
            if (analysisDiv) {
                analysisDiv.innerHTML = `
フォルダヘッダー数: ${folderHeaders.length}
サブフォルダありフォルダ数: ${hasSubfolders.length}
サブフォルダコンテナ数: ${subfolderContainers.length}

詳細はコンソールを確認してください。
                `;
            }
        }

        function listEventListeners() {
            console.log('🎧 イベントリスナーを確認中...');
            
            const container = document.getElementById('bookmarkContainer');
            if (!container) {
                console.error('❌ bookmarkContainer が見つかりません');
                return;
            }

            // イベントリスナーがあるかテスト
            console.log('📋 コンテナに登録されているイベント:');
            console.log('- click イベント:', getEventListeners(container)?.click?.length || 0);
            
            // 手動でテストクリックイベントを発火
            console.log('🧪 テストクリックイベントを作成...');
        }

        function testFolderClicks() {
            console.log('🧪 フォルダクリックテスト開始...');
            
            const container = document.getElementById('bookmarkContainer');
            if (!container) {
                console.error('❌ bookmarkContainer が見つかりません');
                return;
            }

            const folderHeaders = container.querySelectorAll('.folder-header.has-subfolders');
            
            if (folderHeaders.length === 0) {
                console.log('⚠️ サブフォルダを持つフォルダが見つかりません');
                return;
            }

            console.log(`📂 ${folderHeaders.length}個のテスト対象フォルダが見つかりました`);
            
            folderHeaders.forEach((header, index) => {
                const title = header.querySelector('.folder-title')?.textContent;
                console.log(`テスト ${index + 1}: "${title}" をクリック`);
                
                // プログラム的にクリックイベントを発火
                setTimeout(() => {
                    header.click();
                }, (index + 1) * 1000); // 1秒間隔でクリック
            });
        }

        // ページ読み込み時にメッセージを表示
        console.log('🚀 Chrome拡張機能デバッグツール読み込み完了');
        console.log('💡 analyzeStructure() 関数でHTML構造を分析できます');
    </script>
</body>
</html>
